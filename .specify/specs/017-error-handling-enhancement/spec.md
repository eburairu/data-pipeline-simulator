# 機能仕様書: 圧縮ファイルおよびDB書き込みのエラーハンドリング強化

**ID**: 017
**機能ブランチ**: `017-error-handling-enhancement`
**作成日**: 2026-02-08
**ステータス**: 部分的に実装 (Partially Implemented)
**入力**: ユーザー要望 (error-handling-enhancement.md)

## 背景

現状のデータパイプラインシミュレータにおいて、以下の2点のエラーハンドリングが不十分である。
1. 圧縮ファイルを `decompression: false`（展開なし）で読み込むと、パースに失敗しても「生のテキスト」として処理が継続され、ジョブ全体としては「Success」と判定されてしまう。これにより、ユーザーが設定ミスに気づきにくい。
2. データベース（ターゲット）への書き込み時に、レコードのカラムとターゲットテーブルのカラムが一つも一致しない場合でもエラーにならず、空の処理（または無視）が行われ、ジョブが成功してしまう。

## 実装状況の補足
- **実装済み**: ソース読み込み時の圧縮ファイル検知ロジック。
- **未実装**: ターゲット（DB）書き込み時のスキーマバリデーション機能。

## 変更内容

### 1. ソース読み込み時の圧縮ファイル検知
`MappingEngine` がソースファイルを読み込んだ際、ファイル内容がバイナリまたは圧縮形式であるかを判定する。
- **条件**: ファイル内容に対して `isCompressed(rawContent)` が `true` を返し、かつ `MappingSource` 設定の `decompression` が `false` (または未指定) の場合。
- **動作**: ソースノードのエラーカウントをインクリメントし、処理を停止（または当該レコードをスキップ）する。エラーメッセージとして「Compressed file detected but decompression is disabled」などを記録する。

### 2. ターゲット（DB）書き込み時のバリデーション強化
`MappingEngine` がターゲットDBにレコードを書き込む際、カラムのマッチングを検証する。
- **条件**: インサートしようとしているレコードのキー（カラム名）と、ターゲットテーブルのカラム定義を比較し、一致するカラムが一つも存在しない場合。
- **動作**: ターゲットノードのエラーカウントをインクリメントし、当該レコードの書き込みを失敗扱いとする。エラーメッセージとして「No matching columns found for target table」などを記録する。

## ユーザーシナリオとテスト

### シナリオ 1: 展開設定忘れの検知
1. **設定**: `tar.gz` ファイルをソースとし、展開設定をオフにする。
2. **実行**: マッピングジョブを実行。
3. **期待結果**: ジョブがエラー（または警告）となり、詳細に「圧縮ファイルが展開されていない」旨が表示される。

### シナリオ 2: カラム不一致の検知
1. **設定**: `source_col` というカラムのみを持つデータを、`target_col` というカラムのみを持つテーブルに書き込む。
2. **実行**: マッピングジョブを実行。
3. **期待結果**: ジョブの結果において、当該レコードがエラーとしてカウントされ、「カラムが一致しない」旨が記録される。

## 技術仕様

### 変更対象ファイル
- `src/lib/MappingEngine.ts`

### 実装詳細
- `ArchiveEngine` から `isCompressed` 関数をインポート（または `ArchiveEngine.ts` で export されていない場合は export する）。
- `executeMappingTaskRecursive` 関数内のソース読み込み直後にチェックロジックを追加。
- `processTarget` 関数内のDBインサート処理直前に、カラム一致チェックを追加。
