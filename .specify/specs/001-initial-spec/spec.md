# Feature Specification: Data Pipeline Simulator Baseline

**Feature Branch**: `main`
**Created**: 2026-01-25
**Status**: Draft
**Input**: Existing Codebase Analysis

## User Scenarios & Testing

### User Story 1 - データパイプラインのシミュレーション実行 (Priority: P1)

ユーザーはデータ生成からデータベースへの格納までのデータパイプライン全体をシミュレートし、各ステージでのファイルの動きを確認できる。

**Why this priority**: 本アプリケーションの核となる価値であり、データフローの可視化と理解を目的としているため。

**Independent Test**: 設定されたジョブに従ってファイルが生成・移動・処理され、最終的にDBにレコードが格納されることを確認する。

**Acceptance Scenarios**:

1. **Given** デフォルトの設定状態, **When** "Start Auto-Run" ボタンをクリック, **Then** ファイルが定期的に生成され、パイプラインを通って移動し、DBに格納される様子が可視化される。
2. **Given** シミュレーション実行中, **When** "Stop Auto-Run" ボタンをクリック, **Then** 新規のファイル生成と移動処理が停止する。
3. **Given** 停止状態, **When** "Create Source File" ボタンをクリック, **Then** 単発でソースファイルが生成され、パイプライン処理が実行される。

### User Story 2 - パイプライン構成の可視化 (Priority: P1)

ユーザーは現在の設定（ホスト、パス、ジョブ）に基づいたパイプラインの構成図を動的に確認できる。

**Why this priority**: 複雑な設定を直感的に理解するために不可欠であるため。

**Independent Test**: 設定変更（新しいホストやジョブの追加）が即座にダイアグラムに反映されることを確認する。

**Acceptance Scenarios**:

1. **Given** 設定画面, **When** 新しいCollectionジョブを追加（異なるターゲットホストを指定）, **Then** ダイアグラム上に新しいノードとエッジが表示される。
2. **Given** シミュレーション実行中, **When** ファイル転送が発生, **Then** 対応するエッジやノードがアニメーションまたはハイライト表示される。

### User Story 3 - 詳細なインフラとジョブ設定 (Priority: P2)

ユーザーはシミュレーションの前提となるインフラ（ホスト、ディレクトリ）や、各ステージの挙動（帯域幅、遅延、フィルタ）を詳細に設定できる。

**Why this priority**: 様々なシナリオ（低帯域幅、高レイテンシ、特定のファイル名パターンなど）をテストするために必要。

**Independent Test**: 設定を変更し、それがシミュレーションの挙動（処理時間やファイル移動先）に反映されることを確認する。

**Acceptance Scenarios**:

1. **Given** Collection設定, **When** 帯域幅を低く設定, **Then** ファイル転送にかかる時間が増加する（アニメーションの滞在時間が長くなる）。
2. **Given** インフラ設定, **When** 新しいホストを追加, **Then** そのホストがジョブ設定のプルダウンメニューで選択可能になる。

## Requirements

### Functional Requirements

#### コアシステム (Core System)
- **FR-001**: システムはメモリ上で動作する仮想ファイルシステム (Virtual File System) を提供し、`host:path/filename` の形式でファイルを一意に識別・管理しなければならない。
- **FR-002**: システムはメモリ上で動作する仮想データベース (Virtual DB) を提供し、JSON形式のデータをレコードとしてテーブル単位で管理しなければならない。
- **FR-003**: ページリロード時に全てのデータ（ファイル、DBレコード）と状態は初期化（リセット）されなければならない（永続化は行わない）。

#### パイプラインステージ (Pipeline Stages)
- **FR-004 (Data Source)**: 設定されたインターバル、プレフィックス、内容に基づいてファイルを指定のホスト/パスに生成しなければならない。
- **FR-005 (Collection)**: 指定されたソースホスト/パスからターゲットホスト/パスへ、正規表現フィルタに一致するファイルを移動しなければならない。
    - **FR-005-1**: 帯域幅設定に基づき、ファイルサイズに応じた転送遅延をシミュレートしなければならない。
    - **FR-005-2**: 同一ソースパスに対する競合を防ぐためのロック機構を持たなければならない。
- **FR-006 (Delivery)**: Collectionと同様に、ソースからターゲットへのファイル移動を行わなければならない。レイテンシ（処理時間）を追加で設定可能とする。
- **FR-007 (ETL)**: 指定されたパスのファイルを読み込み、Rawテーブルへレコードとして挿入し、元のファイルを削除しなければならない。
- **FR-008 (Transform)**: Rawテーブルのレコードを集計し、Summaryテーブルへ挿入しなければならない。
    - **FR-008-1**: `lastProcessedTimestamp` を利用したインクリメンタル処理を行い、二重集計を防がなければならない。

#### ユーザーインターフェース (UI)
- **FR-009**: React Flow を使用して、現在の設定に基づいたノード（ストレージ）とエッジ（処理）のグラフを描画しなければならない。
- **FR-010**: 現在の処理ステップ（転送中、ETL実行中など）を視覚的に表現（アクティブ状態のハイライトなど）しなければならない。
- **FR-011**: 各ステージのファイル一覧とDBのレコード内容をリアルタイムで表示しなければならない。
- **FR-012**: エラー（正規表現ミス、移動失敗など）が発生した場合、ユーザーに通知しなければならない。

### Key Entities

- **VFile**: 仮想ファイル。`name`, `host`, `path`, `content`, `createdAt` を持つ。
- **DBRecord**: 仮想DBレコード。`id`, `data`, `table`, `insertedAt` を持つ。
- **Job**: 各ステージ（DataSource, Collection, Delivery）の処理単位。`sourceHost`, `targetHost`, `bandwidth` などの設定を持つ。
- **Host**: ファイルが存在する仮想サーバー。`name`, `directories` を持つ。

## Success Criteria

### Measurable Outcomes

- **SC-001**: デフォルト設定において、Auto-Run開始から5秒以内にファイルが生成され、Summary DBまでデータが到達すること。
- **SC-002**: ユーザーが設定を変更（例: 収集ジョブの追加）してから1秒以内に、フロー図が更新されること。
- **SC-003**: 複数のジョブが並行して実行されている際、競合エラー（ファイルロックなど）によりアプリがクラッシュしないこと。
